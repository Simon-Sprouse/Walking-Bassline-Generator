@page "/"
@using BlazorWalkingBassline.Models
@using BlazorWalkingBassline.MusicTheory

@inject IJSRuntime JS

<style>
    :host {
        --slot-width-ch: @(SlotWidth)ch;
    }
</style>



<PageTitle>Walking Basslines</PageTitle>
<h1>Walking Bassline Generator</h1>

<button @onclick="GenerateMidiTrack">Allow Broswer Audio</button>
<button @onclick="PlayGeneratedAudio">Play Audio</button>
<button @onclick="PauseAudio">Pause Audio</button>
<button @onclick="StopAudio">Stop Audio</button>
<button @onclick="ToggleLooping" class="@(_isLooping ? "btn-success" : "btn-secondary")">
    @if (_isLooping)
    {
        <span>✅ Looping ON</span>
    }
    else
    {
        <span>🔁 Looping OFF</span>
    }
</button>



@* TODO This should be a component *@
<h2>Bass Tab Preview</h2>
<div class="tab-output">
    @if (TabColumns.Any())
    {
        @for (int i = 0; i < TabColumns.Count; i++)
        {
            var column = TabColumns[i];
            
            // Determine if the current column should have the playhead highlight class
            string columnClass = (i == _highlightedColumnIndex) ? "playhead-highlight" : "";

            if (column.Type == ColumnType.HeaderLine)
            {
                <div class="tab-header tab-column-wrapper">
                    @foreach (var line in column.StringLines)
                    {
                        <span class="string-line">@line</span>
                    }
                </div>
            }
            else if (column.Type == ColumnType.BarLine)
            {
                <div class="tab-bar-line tab-column-wrapper"> 
                    @foreach (var line in column.StringLines)
                    {
                        <span class="string-line">@line</span>
                    }
                </div>
            }
            else /* Content column */
            {
                @* This is now the ONLY clickable column type *@
                <div class="tab-content tab-column-wrapper @columnClass" @onclick="() => HandleClick(column)">
                    @foreach (var line in column.StringLines)
                    {
                        <span class="string-line">@line</span>
                    }
                </div>
            }
        }
    }
    else
    {
        <p>Generating Tab...</p>
    }
</div>




@code {


    private const double BPM = 120.0; // TODO make dynamic
    private const double QuarterNoteDurationSeconds = 60.0 / BPM;
    public int SlotWidth = 6;
    private bool _isLooping = false;
    private Progression progression;
    private IProgressionGenerator generator;
    private List<TabNote> tabNotes;
    private List<TabColumn> TabColumns { get; set; } = new();


    /*=============================================================================
    //  These functions allow JS to exclusively update the visual playhead 
    =============================================================================*/
    private DotNetObjectReference<Index>? _dotNetRef;
    public int _highlightedColumnIndex = -1; // -1 means no highlight
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Create the .NET reference and pass it to JavaScript
            _dotNetRef = DotNetObjectReference.Create(this);
            // This is a new interop call we will add to audio.js
            await JS.InvokeVoidAsync("toneInterop.setDotNetReference", _dotNetRef);
        }
    }
    public void Dispose()
    {
        _dotNetRef?.Dispose();
    }

    [JSInvokable]
    public void SetHighlightColumn(int columnIndex)
    {
        // Check for the "no highlight" signal
        if (columnIndex == -1)
        {
            if (_highlightedColumnIndex != -1)
            {
                _highlightedColumnIndex = -1;
                // Since this might be the end of playback or a pause gap, 
                // we force StateHasChanged if the highlight was on.
                StateHasChanged(); 
            }
            return;
        }

        // Handle valid highlight index
        if (columnIndex >= 0 && columnIndex < TabColumns.Count)
        {
            // ONLY set the highlight index if the column is a Content column (a beat/note)
            if (TabColumns[columnIndex].Type == ColumnType.Content)
            {
                if (columnIndex != _highlightedColumnIndex)
                {
                    _highlightedColumnIndex = columnIndex;
                    // StateHasChanged is called implicitly/by Blazor
                    // Console.WriteLine($"Highlighting content column index: {_highlightedColumnIndex}");
                    StateHasChanged(); // Force update to ensure immediate highlight change
                }
                return;
            }
        }
        
        // If the index was for a non-content column but was not -1, remove the highlight
        if (_highlightedColumnIndex != -1)
        {
             _highlightedColumnIndex = -1;
             StateHasChanged();
        }
    }

    

    /*=============================================================================
    //                      Logic for Ui/UX Buttons
    =============================================================================*/

    private async Task GenerateMidiTrack()
    {

        // Initialize generator
        int[] formula = { 1, 3, 5, 6 };
        generator = new Generator(formula);

        // Initialize progression
        double beat = 1; // TODO make dynamic (right now we assume every chord starts on first beat)
        double duration = 4; // TODO later make this dynamic
        string key = "A";

        List<Chord> chords = new List<Chord>
        {
            new Chord(ScaleDegree.Six, ChordQuality.Minor, 1, beat, duration),
            new Chord(ScaleDegree.One, ChordQuality.Major, 2, beat, duration),
            new Chord(ScaleDegree.Five, ChordQuality.Major, 3, beat, duration),
            new Chord(ScaleDegree.Four, ChordQuality.Major, 4, beat, duration),
            
        };

        progression = new Progression(key, chords, generator);
        tabNotes = FretboardMapper.MapNotesToTab(progression.Notes);
        TabColumns = TabFormatter.RenderAscii(tabNotes, SlotWidth);

        // Convert C# Note objects to a simplified list for JS using the new helper
        var jsNotes = MidiConverter.ConvertNotesToJsSequence(progression.Notes, BPM);
        await JS.InvokeVoidAsync("toneInterop.generateMidiTrack", jsNotes, BPM);
    }

    private async Task PlayGeneratedAudio()
    {
        await JS.InvokeVoidAsync("toneInterop.playGeneratedAudio");
        // Don't set _highlightedColumnIndex here - let JavaScript control it via SetHighlightColumn
    }

    private async Task PauseAudio() 
    { 
        await JS.InvokeVoidAsync("toneInterop.pauseAudio");
    }

    private async Task StopAudio() 
    {
        await JS.InvokeVoidAsync("toneInterop.stopAudio");
        _highlightedColumnIndex = -1; // Reset visual playhead
        StateHasChanged(); // Force UI update
    }

    private async Task ToggleLooping()
    {
        _isLooping = !_isLooping;
        await JS.InvokeVoidAsync("toneInterop.toggleLooping", _isLooping);
        StateHasChanged(); // Update the button text
    }


    // Runs when user clicks the track to move the playhead
    private async Task HandleClick(TabColumn column)
    {

        // Calculate the time (in seconds) with same calculation used in GenerateMidiTrack
        double absoluteBeat = (column.Measure - 1) * 4 + (column.Beat - 1);
        double timeInSeconds = absoluteBeat * QuarterNoteDurationSeconds;
        
        // Seek to that time
        await JS.InvokeVoidAsync("toneInterop.seekToTime", timeInSeconds); 

        // JS handles visual update
    }


}
