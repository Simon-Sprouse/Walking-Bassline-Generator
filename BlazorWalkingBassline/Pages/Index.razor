@page "/"
@using BlazorWalkingBassline.Models
@using BlazorWalkingBassline.MusicTheory

@inject IJSRuntime JS

<PageTitle>Walking Basslines</PageTitle>

<h1>Walking Bassline Generator</h1>

<h2>Chords in Progression</h2>
@foreach (var chord in progression.Chords) 
{ 
    <p>@chord.ToString()</p>
}

<h2>Generated Chord Notes (Midi Number)</h2>
@foreach (var pair in chordNotesList)
{
    <p>@pair.chord: @string.Join(", ", pair.notes)</p>
}

<h2>Generated Chord Names (Midi Number)</h2>
@foreach (var pair in chordNotesList)
{
    <p>@pair.chord: @string.Join(", ", pair.notes.Select(m => generator.NoteFromMidi(m)))</p>
}

<h2>ASCII Bass Tab Prototype</h2>

<pre>@TabFormatter.RenderAscii(tabNotesList)</pre>


<h2>Test JS Interop</h2>
<button @onclick="RunTest">Run JS Test</button>
<button @onclick="StartAudio">Start Audio</button>
<button @onclick="PlayTone">Play Note</button>

<h2>Audio File Generation</h2>
<button @onclick="GenerateAudioFile">Generate Audio File</button>
<button @onclick="PlayGeneratedAudio">Play Generated Audio</button>
<button @onclick="PauseAudio">Pause Audio</button>
<button @onclick="StopAudio">Stop Audio</button>

@code {

    private Progression progression;
    private Generator generator;
    private List<(Chord chord, List<int> notes)> chordNotesList;

    private List<(Chord chord, List<TabNote>)> tabNotesList;

    protected override void OnInitialized()
    {
        // Initialize progression
        progression = new Progression(
            "G",
            new List<Chord>
            {
                new Chord(ScaleDegree.One),
                new Chord(ScaleDegree.Five),
                new Chord(ScaleDegree.Two),
                new Chord(ScaleDegree.Four)
            }
        );

        // Initialize generator
        generator = new Generator(progression);

        // Generate chord notes
        Console.WriteLine("Generating Chords");
        chordNotesList = generator.GenerateChordNotes();



        // Map generated chord MIDI notes to TabNotes using the greedy fretboard mapper
        tabNotesList = FretboardMapper.MapChordsToTab(chordNotesList);

    }


    private async Task RunTest() 
    {
        await JS.InvokeVoidAsync("testJS");
    }


    private bool audioStarted = false;

    private async Task StartAudio()
    {
        await JS.InvokeVoidAsync("toneInterop.startAudio");
        audioStarted = true;
    }

    private async Task PlayTone()
    {
        if (!audioStarted)
        {
            Console.WriteLine("⚠️ Please start audio first!");
            return;
        }

        await JS.InvokeVoidAsync("toneInterop.playNote", "C3", "8n");
    }

    private async Task GenerateAudioFile()
    {
        await JS.InvokeVoidAsync("toneInterop.generateAudioFile");
    }

    private async Task PlayGeneratedAudio()
    {
        await JS.InvokeVoidAsync("toneInterop.playGeneratedAudio");
    }
    
    private async Task StopAudio() 
    {
        // resets playhead
        await JS.InvokeVoidAsync("toneInterop.stopAudio");
    }

    private async Task PauseAudio() 
    { 
        await JS.InvokeVoidAsync("toneInterop.pauseAudio");
    }


}
